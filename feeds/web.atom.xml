<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Logan's Note</title><link href="http://logan.tw/" rel="alternate"></link><link href="http://logan.tw/feeds/web.atom.xml" rel="self"></link><id>http://logan.tw/</id><updated>2014-12-15T18:04:00+08:00</updated><entry><title>Autossh and Ubuntu Upstart Daemon</title><link href="http://logan.tw/posts/2014/12/15/autossh-and-ubuntu-upstart-daemon/" rel="alternate"></link><updated>2014-12-15T18:04:00+08:00</updated><author><name>Logan</name></author><id>tag:logan.tw,2014-12-15:posts/2014/12/15/autossh-and-ubuntu-upstart-daemon/</id><summary type="html">&lt;p&gt;Since I am sharing the network without public IP, I would like to maintain a
SSH tunnel so that I can connect to my desktop from the remote site.  After
searching the web, I found that &lt;a class="reference external" href="http://www.harding.motd.ca/autossh/"&gt;Autossh&lt;/a&gt; fits my needs.  &lt;a class="reference external" href="http://www.harding.motd.ca/autossh/"&gt;Autossh&lt;/a&gt; is a
utility that can start and monitor the SSH tunnel.  If the connections are
broken, then &lt;a class="reference external" href="http://www.harding.motd.ca/autossh/"&gt;Autossh&lt;/a&gt; will restart the SSH connection automatically.&lt;/p&gt;
&lt;p&gt;In this post, I would like to introduce how to setup an autossh daemon with
&lt;a class="reference external" href="http://upstart.ubuntu.com"&gt;Ubuntu Upstart&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="setup-local-host"&gt;
&lt;h2&gt;Setup Local Host&lt;/h2&gt;
&lt;p&gt;First, create a new user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Create a new user named &amp;quot;autossh&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;sudo adduser --system --group --disabled-password autossh

&lt;span class="c"&gt;# Login as autossh&lt;/span&gt;
autossh:~&lt;span class="nv"&gt;$ &lt;/span&gt;sudo su autossh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Second, record the remote SSH server key:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;autossh:~&lt;span class="nv"&gt;$ &lt;/span&gt;ssh-keyscan &lt;span class="o"&gt;[&lt;/span&gt;remote&lt;span class="o"&gt;]&lt;/span&gt; &amp;gt;&amp;gt; ~/.ssh/known_hosts
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Third, create SSH public keys:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Create SSH private and public keys&lt;/span&gt;
autossh:~&lt;span class="nv"&gt;$ &lt;/span&gt;ssh-keygen -t rsa
Enter file in which to save the key &lt;span class="o"&gt;(&lt;/span&gt;/home/autossh/.ssh/id_rsa&lt;span class="o"&gt;)&lt;/span&gt;: &lt;span class="o"&gt;[&lt;/span&gt;enter&lt;span class="o"&gt;]&lt;/span&gt;
Created directory &lt;span class="s1"&gt;&amp;#39;/home/autossh/.ssh&amp;#39;&lt;/span&gt;.
Enter passphrase &lt;span class="o"&gt;(&lt;/span&gt;empty &lt;span class="k"&gt;for&lt;/span&gt; no passphrase&lt;span class="o"&gt;)&lt;/span&gt;: &lt;span class="o"&gt;[&lt;/span&gt;enter&lt;span class="o"&gt;]&lt;/span&gt;
Enter same passphrase again: &lt;span class="o"&gt;[&lt;/span&gt;enter&lt;span class="o"&gt;]&lt;/span&gt;

&lt;span class="c"&gt;# Print the public key&lt;/span&gt;
autossh:~&lt;span class="nv"&gt;$ &lt;/span&gt;cat ~/.ssh/id_rsa.pub
&lt;span class="o"&gt;[&lt;/span&gt;copy the output line&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fourth, logout and disable the shell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;autossh:~&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;sudo chsh --shell /bin/false autossh
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="setup-remote-host"&gt;
&lt;h2&gt;Setup Remote Host&lt;/h2&gt;
&lt;p&gt;First, create a new user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Login to the remote host&lt;/span&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;ssh &lt;span class="o"&gt;[&lt;/span&gt;user&lt;span class="o"&gt;]&lt;/span&gt;@&lt;span class="o"&gt;[&lt;/span&gt;remote&lt;span class="o"&gt;]&lt;/span&gt;

&lt;span class="c"&gt;# Create a new user&lt;/span&gt;
remote:~&lt;span class="nv"&gt;$ &lt;/span&gt;sudo adduser --system --group --shell /bin/false &lt;span class="se"&gt;\&lt;/span&gt;
                       --disabled-password autossh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Second, add the authorized public key:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Create directory for authorized keys&lt;/span&gt;
remote:~&lt;span class="nv"&gt;$ &lt;/span&gt;sudo mkdir -p /home/autossh/.ssh

&lt;span class="c"&gt;# Add new public key&lt;/span&gt;
remote:~&lt;span class="nv"&gt;$ &lt;/span&gt;sudo vi /home/autossh/.ssh/authorized_keys
&lt;span class="o"&gt;[&lt;/span&gt;paste the public key&lt;span class="o"&gt;]&lt;/span&gt;

&lt;span class="c"&gt;# Change the owner of the file&lt;/span&gt;
remote:~&lt;span class="nv"&gt;$ &lt;/span&gt;sudo chown -R autossh:autossh /home/autossh/.ssh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We have finished the configuration on the remote host, logout from the remote
host with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;remote:~&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="setup-upstart-configuration-file"&gt;
&lt;h2&gt;Setup Upstart Configuration File&lt;/h2&gt;
&lt;p&gt;Let's add the Ubuntu Upstart configuration file.&lt;/p&gt;
&lt;p&gt;First, create new upstart configuration with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;sudo vim /etc/init/autossh.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add following lines to the file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;description &amp;quot;autossh daemon for ssh tunnel&amp;quot;

start on net-device-up IFACE=eth0
stop on runlevel [01S6]

setuid autossh

respawn
respawn limit 5 60

script
export AUTOSSH_FIRST_POLL=30
export AUTOSSH_GATETIME=0
export AUTOSSH_POLL=60
autossh -M [daemon-port] -N -R [remote-port]:localhost:22 [remote] -i /home/autossh/.ssh/id_rsa
end script
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change the variables properly.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;code&gt;[daemon-port]&lt;/code&gt; can be any number larger than 8000.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;[remote-port]&lt;/code&gt; is the remote port that will be opened on remote host
which will be mapped to local port.&lt;/li&gt;
&lt;li&gt;For the exported environment variables, you can refer to the &lt;a class="reference external" href="http://manpages.ubuntu.com/manpages/utopic/en/man1/autossh.1.html"&gt;autossh manual
pages&lt;/a&gt; for further details.  Usually, you would like to set
&lt;code&gt;AUTOSSH_GATETIME&lt;/code&gt; to zero.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Finally, start the service now:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;sudo service autossh start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After these steps, the SSH tunnel should start to work now!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reference"&gt;
&lt;h2&gt;Reference&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.ubuntugeek.com/automatically-restart-ssh-sessions-and-tunnels-using-autossh.html"&gt;Automatically restart SSH sessions and tunnels Using Autossh&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</summary><category term="ssh"></category><category term="autossh"></category><category term="upstart"></category><category term="init"></category></entry><entry><title>Let's Encrypt</title><link href="http://logan.tw/posts/2014/11/24/lets-encrypt/" rel="alternate"></link><updated>2014-11-24T23:32:00+08:00</updated><author><name>Logan</name></author><id>tag:logan.tw,2014-11-24:posts/2014/11/24/lets-encrypt/</id><summary type="html">&lt;p&gt;According to the &lt;a class="reference external" href="http://andreasgal.com/2014/11/18/lets-encrypt-one-more-step-on-the-road-to-tls-everywhere/"&gt;post&lt;/a&gt; by &lt;a class="reference external" href="http://andreasgal.com"&gt;Andreas Gal&lt;/a&gt;, &lt;a class="reference external" href="https://www.eff.org/"&gt;EFF&lt;/a&gt;, &lt;a class="reference external" href="https://mozilla.com/"&gt;Mozilla&lt;/a&gt;, Cisco, Akamai,
and IdenTrust are going to form Internet Security Research Group which will
start the &lt;a class="reference external" href="https://letsencrypt.org/"&gt;Let's Encrypt&lt;/a&gt; ceritificate authority service in 2015 Q2.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://letsencrypt.org/"&gt;Let's Encrypt&lt;/a&gt; is expected to become a free, automated, and open SSL
sertificate authority which aims to increase the adoption of HTTPS protocol
and provide a more secure Internet.  I am looking forward to this project.&lt;/p&gt;
&lt;p&gt;For the impatient, you may check &lt;a class="reference external" href="https://github.com/letsencrypt"&gt;their GitHub&lt;/a&gt; for the preview release.&lt;/p&gt;
</summary><category term="http"></category><category term="ssl"></category></entry><entry><title>GitHub Pages and HTTPS</title><link href="http://logan.tw/posts/2014/11/16/github-pages-and-https/" rel="alternate"></link><updated>2014-11-16T23:31:00+08:00</updated><author><name>Logan</name></author><id>tag:logan.tw,2014-11-16:posts/2014/11/16/github-pages-and-https/</id><summary type="html">&lt;p&gt;&lt;a class="reference external" href="https://pages.github.com"&gt;GitHub Pages&lt;/a&gt; supports HTTPS protocol.  It will be good to prefer HTTPS to
HTTP.  However, I found that if the URLs are not written carefully, the
user might be redirected to HTTP URLs.&lt;/p&gt;
&lt;p&gt;For unknown reason, &lt;a class="reference external" href="https://pages.github.com"&gt;GitHub Pages&lt;/a&gt; are redirecting the directories without
trailing slash to the HTTP URLs.  For example, the following URL:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
https://loganchien.github.io/cert
&lt;/pre&gt;
&lt;p&gt;will be redirected to:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
http://loganchien.github.io/cert/
&lt;/pre&gt;
&lt;p&gt;To avoid this pitfall, please make sure that your URLs are ending with trailing
slash if they are pointing to directories.  For example,&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
https://loganchien.github.io/cert/
&lt;/pre&gt;
&lt;p&gt;This URL won't be redirected and work as expected.&lt;/p&gt;
</summary><category term="github"></category><category term="https"></category></entry><entry><title>Pelican and GitHub Pages</title><link href="http://logan.tw/posts/2014/11/16/pelican-and-github-pages/" rel="alternate"></link><updated>2014-11-16T23:01:00+08:00</updated><author><name>Logan</name></author><id>tag:logan.tw,2014-11-16:posts/2014/11/16/pelican-and-github-pages/</id><summary type="html">&lt;p&gt;&lt;a class="reference external" href="http://docs.getpelican.com"&gt;Pelican&lt;/a&gt; has built-in support for &lt;a class="reference external" href="https://pages.github.com"&gt;GitHub Pages&lt;/a&gt;.  However, I noticed that
the &lt;code&gt;ghp-import&lt;/code&gt; command might screw up the commit log if your GitHub
Pages and your Pelican source code share the same branch name.&lt;/p&gt;
&lt;p&gt;According to the document of &lt;a class="reference external" href="https://pages.github.com"&gt;GitHub Pages&lt;/a&gt;, the user pages should be
committed to &lt;code&gt;master&lt;/code&gt; branch (instead of &lt;code&gt;gh_pages&lt;/code&gt;.)  If you have
answered &lt;code&gt;master&lt;/code&gt; while &lt;code&gt;pelican-quickstart&lt;/code&gt; was asking for the
GitHub Page branch, then &lt;code&gt;ghp-import&lt;/code&gt; will automatically commit the
generated output to the &lt;code&gt;master&lt;/code&gt; branch.  Consequently, the git
repository will be screwed up.&lt;/p&gt;
&lt;p&gt;My solution is to create a &lt;code&gt;pelican-source&lt;/code&gt; branch for Pelican source
code, and commit the generated output to the &lt;code&gt;master&lt;/code&gt; branch.  This will
fix this issue without any problems.&lt;/p&gt;
</summary><category term="github"></category><category term="pelican"></category></entry><entry><title>SSL Certificate</title><link href="http://logan.tw/posts/2014/11/15/ssl-certificate/" rel="alternate"></link><updated>2014-11-15T02:30:00+08:00</updated><author><name>Logan</name></author><id>tag:logan.tw,2014-11-15:posts/2014/11/15/ssl-certificate/</id><summary type="html">&lt;p&gt;I would like to run &lt;a class="reference external" href="https://code.google.com/p/shellinabox/"&gt;shellinabox&lt;/a&gt; and my private blog system through HTTPS
protocol.  However, an SSL certificate is really expensive, thus I decided to
run our own &lt;strong&gt;certificate authority&lt;/strong&gt; and distribute my &lt;em&gt;cacert.pem&lt;/em&gt; through
&lt;a class="reference external" href="https://pages.github.com"&gt;GitHub Pages&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In general, running a certificate authority requires three steps:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Create a RSA public/private keys for the CA.  This step will create
&lt;code&gt;cacert.pem&lt;/code&gt; as well.  You should distribute the CA certificate via
some safe tunnel.&lt;/li&gt;
&lt;li&gt;For each service, create a &lt;em&gt;certificate request&lt;/em&gt; and send it to CA.&lt;/li&gt;
&lt;li&gt;The CA should sign the certificate request, and return it back.&lt;/li&gt;
&lt;li&gt;Install the CA-signed SSL certificate to HTTPS server (and etc.)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The OpenSSL package from Ubuntu has provide a simple script for us to
manage the certificates.  Let's start.&lt;/p&gt;
&lt;div class="section" id="create-a-certificate-authority"&gt;
&lt;h2&gt;Create a Certificate Authority&lt;/h2&gt;
&lt;p&gt;Create directory to save everything:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;mkdir MyCA
&lt;span class="nv"&gt;$ &lt;/span&gt;chmod &lt;span class="m"&gt;700&lt;/span&gt; MyCA
&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;cd &lt;/span&gt;MyCA
&lt;/pre&gt;
&lt;p&gt;Copy the tools:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;cp /usr/lib/ssl/misc/CA.pl .
&lt;span class="nv"&gt;$ &lt;/span&gt;cp /etc/ssl/openssl.cnf .
&lt;/pre&gt;
&lt;p&gt;Edit the configurations to fit your need, and finally create the certificate
for your CA:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;./CA.pl -newca
&lt;/pre&gt;
&lt;p&gt;By default, the &lt;code&gt;cacert.pem&lt;/code&gt; will be generated at
&lt;code&gt;demoCA/cacert.pem&lt;/code&gt;.  Install this certificate as an authority in your
browser.  You can also check the fingerprint with:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;openssl x509 -fingerprint -noout -in cacert.pem
&lt;span class="nv"&gt;$ &lt;/span&gt;openssl x509 -sha256 -fingerprint -noout -in cacert.pem
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="generate-certificates-for-your-service"&gt;
&lt;h2&gt;Generate Certificates for Your Service&lt;/h2&gt;
&lt;p&gt;To create the SSL certificate for your service:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="c"&gt;# Create a certificate request
&lt;/span&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;./CA.pl -newreq

&lt;span class="c"&gt;# Sign a certificate request
&lt;/span&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;./CA.pl -sign
&lt;/pre&gt;
&lt;p&gt;The generated &lt;code&gt;newkey.pem&lt;/code&gt; and &lt;code&gt;newcert.pem&lt;/code&gt; are the private key
and the certificate respectively.&lt;/p&gt;
&lt;p&gt;Please notice that the &lt;code&gt;newkey.pem&lt;/code&gt; has been encrypted with a passpharse.
Under some situation, you have to decrypt it before installing the certificate
(e.g. Apache2).  Here's the command to decrypt the private key:&lt;/p&gt;
&lt;pre class="code bash literal-block"&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;openssl rsa -in newkey.pem -out newkey.nopass.pem
&lt;/pre&gt;
&lt;/div&gt;
</summary><category term="https"></category><category term="apache2"></category><category term="ssl"></category></entry></feed>