<!DOCTYPE html>
<html lang="en">
<head>
	<title>Flask and Socket.IO | Logan's Note</title>

	<meta charset="utf-8" />
	<link href="http://logan.tw/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Logan's Note Full Atom Feed" />
	<link href="http://logan.tw/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Logan's Note Atom Feed" />
	<link href="http://logan.tw/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Logan's Note RSS Feed" />
	<link href="http://logan.tw/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Logan's Note Categories Atom Feed" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Source+Sans+Pro:400,700,400italic,700italic|Source+Code+Pro:400,700" />
	<link rel="stylesheet" type="text/css" href="/theme/css/main.css" media="all" />
	<link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" media="all" />

	<link rel="apple-touch-icon" sizes="180x180" href="/theme/images/favicon-180.png" />
	<link rel="icon" type="image/png" href="/theme/images/favicon-192.png" sizes="192x192" />
	<link rel="icon" type="image/png" href="/theme/images/favicon-96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="/theme/images/favicon-32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="/theme/images/favicon-16.png" sizes="16x16" />

	<!--[if lte IE 8]>
	<script type="text/javascript" src="/theme/js/respond.min.js"></script>
	<![endif]-->


	<meta name="tags" content="python" />
	<meta name="tags" content="flask" />
	<meta name="tags" content="socketio" />

	<meta property="og:title" content="Flask and Socket.IO" />
	<meta property="og:url" content="http://logan.tw/posts/2016/01/16/flask-and-socketio/" />
</head>

<body>
	<div id="container">
		<div id="content">
<h1 class="entry-title">
        <a href="http://logan.tw/posts/2016/01/16/flask-and-socketio/" rel="bookmark" title="Permalink to Flask and Socket.IO">Flask and Socket.IO</a>
</h1>



<div class="post-info">
	<time class="published" datetime="2016-01-16T15:03:00+08:00">
		Sat 16 January 2016
	</time>

	<div class="tags">
		<span class="tags-label">Tags</span>
		<a class="tags" href="/tag/python/">python</a>
		<a class="tags" href="/tag/flask/">flask</a>
		<a class="tags" href="/tag/socketio/">socketio</a>
	</div>

	<address class="vcard author">
		Posted by <a class="url fn" href="/author/logan/">Logan</a>	</address>
</div>

<div class="entry-content">
<p>Under some scenarios, we would like to push a message from an HTTP server to
clients.  For example, in a group messaging application, whenever a user sends a
message to the server, the server has to push such message to everyone.  Since
2001, several techniques have been proposed.  Eventually, <a class="reference external" href="https://en.wikipedia.org/wiki/WebSocket">WebSocket</a> has been
developed and standardized in 2011.  WebSocket is a full-duplex protocol that
supports bidirectional communications between servers and clients.  It is
supported by all modern browsers.</p>
<p>On top of WebSocket, <a class="reference external" href="https://socket.io/">Socket.IO</a> is a Javascript library that abstracts the
protocol details.  Socket.IO provides an event-driven interface and
serializes JSON data automatically.  Socket.IO even implements other pushing
technologies.  If a browser does not support WebSocket, Socket.IO will fall
back to long polling protocol.  These characteristics make Socket.IO quite
appealing to web developers.</p>
<p>In this post, I would like to demonstrate how to build a chat room application
named <strong>LiveChat</strong> with <a class="reference external" href="http://flask.pocoo.org/">Flask</a> (server side) and <a class="reference external" href="https://socket.io/">Socket.IO</a> (client side).</p>
<div class="section" id="prerequisite">
<h2>Prerequisite</h2>
<p>The <em>LiveChat</em> application requires 3 Python packages: <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, <a class="reference external" href="https://flask-socketio.readthedocs.io">Flask-SocketIO</a>,
and <a class="reference external" href="http://eventlet.net">Eventlet</a>.  Flask is a well-known Python web framework.  Flask-SocketIO
implements the Socket.IO protocol and provides Socket.IO APIs for Flask
applications.  Eventlet is an efficient event-based networking library that are
used by Flask-SocketIO.</p>
<p>To install these packages, create a <code>requirements.txt</code> with:</p>
<div class="highlight"><pre><span></span>Flask==0.10.1
Flask-SocketIO==1.2
eventlet==0.17.4
</pre></div>
<p>And then, run <code>pip install</code>:</p>
<div class="highlight"><pre><span></span>$ pip intall -r requirements.txt
</pre></div>
</div>
<div class="section" id="sending-and-receiving-messages">
<h2>Sending and Receiving Messages</h2>
<p>Let's start with sending and receiving messages.  In the initial simplistic
design, the user will send a message to server and the server will relay the
message to all users.  Whenever a user receives a message, the Javascript
client renders the messsage in the HTML document.</p>
<p>The protocol for the initial simplistic design consists of two <strong>events</strong>:</p>
<ul class="simple">
<li><code>send-msg</code> -- A client sends a message to the server.  Its payload is a
string which stands for the message to be sent.</li>
<li><code>show-msg</code> -- The server broadcast a message to all clients.  Its
payload is a string which should be rendered.</li>
</ul>
<p>Now, let's look at the code.</p>
<p>First, <code>templates/index.html</code> contains the HTML for the user interface.
There is a <code>&lt;form&gt;</code> for users to enter their messages.  In addition, there
are two <code>&lt;script&gt;</code> tags, which include <code>socket.io.min.js</code> and
<code>livechat.js</code>.</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>

<span class="p">&lt;</span><span class="nt">html</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>LiveChat<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/static/livechat.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;inputForm&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="p">/&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Send&quot;</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;stream&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>Second, <code>static/livechat.js</code> contains the client-side Javascript code:</p>
<div class="highlight"><pre><span></span><span class="p">;(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">domInput</span><span class="p">,</span> <span class="nx">domStream</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">createMessageDOM</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span><span class="p">;</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">showMsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">domStream</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">createMessageDOM</span><span class="p">(</span><span class="nx">msg</span><span class="p">),</span> <span class="nx">domStream</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send-msg&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onSubmit</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">domInput</span> <span class="o">&amp;&amp;</span> <span class="nx">domInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">domInput</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="nx">domInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">initSocketIO</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;show-msg&#39;</span><span class="p">,</span> <span class="nx">showMsg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onDOMContentLoaded</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">domInputForm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;inputForm&#39;</span><span class="p">)</span>
        <span class="nx">domInputForm</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nx">onSubmit</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="nx">domInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">);</span>
        <span class="nx">domStream</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">);</span>

        <span class="nx">initSocketIO</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="nx">onDOMContentLoaded</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>
<p>To sum up, <code>livechat.js</code> will:</p>
<ul class="simple">
<li>Connect to the server with <code>io.connect()</code>.</li>
<li>Register a Socket.IO event listener with <code>socket.on()</code>.  In the code
snippet, the function <code>showMsg()</code> is registered as the event handler for
<code>show-msg</code> event.</li>
<li>If a <code>show-msg</code> event arrives, <code>showMsg()</code> will create a DOM
element and add it to the document with <code>domStream.insertBefore()</code>.</li>
<li>Register a DOM event listener with <code>domInputForm.addEventListener()</code>
to capture the <code>submit</code> event.</li>
<li>If a user clicks the <em>Send</em> button, the event handler <code>onSubmit()</code>
will emit a <code>send-msg</code> event with <code>socket.emit('send-msg', ...)</code>.</li>
</ul>
<p>Third, <code>livechat.py</code> contains the server-side Python code:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_socketio</span> <span class="kn">import</span> <span class="n">SocketIO</span><span class="p">,</span> <span class="n">emit</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">socketio</span> <span class="o">=</span> <span class="n">SocketIO</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>

<span class="nd">@socketio.on</span><span class="p">(</span><span class="s1">&#39;send-msg&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">emit</span><span class="p">(</span><span class="s1">&#39;show-msg&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">socketio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
<p>To sum up, <code>livechat.py</code> performs following tasks:</p>
<ul class="simple">
<li><code>index()</code> will handle the HTTP request to the path <code>/</code>.
It will return <code>templates/index.html</code> when there is an HTTP request from
a client.</li>
<li><code>handle_message()</code> is decorated by <code>&#64;socketio.on()</code> decorator.
With this decorator, <code>handle_message()</code> will be called when a
client emits the <code>send-msg</code> event.</li>
<li><code>handle_message()</code> will call <code>flask_socketio.emit()</code> with
<code>broadcast=True</code> to emit <code>show-msg</code> events to all users.</li>
</ul>
<p>Now, let's run our initial implementation:</p>
<div class="highlight"><pre><span></span>$ python livechat.py
* Restarting with stat
* Debugger is active!
* Debugger PIN: <span class="m">000</span>-000-000
<span class="o">(</span><span class="m">24559</span><span class="o">)</span> wsgi starting up on http://127.0.0.1:5000/
</pre></div>
<p>Open the browser and visit <a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a>.  You can also open two tabs
and check whether they can send the messages to each other.</p>
</div>
<div class="section" id="message-history">
<h2>Message History</h2>
<p>In the initial design, users will only receive the messages that are sent after
they have joinned.  In this section, we would like to extend our LiveChat
application so that the server can send the message history to newly joinned
users.</p>
<p>Two events are added to the protocol:</p>
<ul class="simple">
<li><code>request-all-msgs</code> -- A client requests for message history.  This event
will be emitted when the connection is established.</li>
<li><code>show-all-msgs</code> -- In response to the <code>request-all-msgs</code> event,
the server will send the message history to the client with the
<code>show-all-msgs</code> event.  Its payload is an array of strings which stands
for the message history.</li>
</ul>
<p>On the client side, two extra event handlers are registered.  One is for the
<code>connect</code> event and the other is for the <code>show-all-msgs</code> event.
After the connection is established, the <code>connect</code> event handler will be
called. It will send a <code>request-all-msgs</code> event to the server to request
for message history.  After the server replies, the <code>show-all-msgs</code> event
handler will be called and show the messages with <code>showAllMsgs()</code>:</p>
<div class="highlight"><pre><span></span><span class="p">;(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ... Omitted ...</span>

    <span class="kd">function</span> <span class="nx">showMsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">domStream</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">createMessageDOM</span><span class="p">(</span><span class="nx">msg</span><span class="p">),</span> <span class="nx">domStream</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">showAllMsgs</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">domStreamNew</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">msgs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">showMsg</span><span class="p">(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ... Omitted ...</span>

    <span class="kd">function</span> <span class="nx">initSocketIO</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">domain</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
        <span class="nx">socket</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;show-msg&#39;</span><span class="p">,</span> <span class="nx">showMsg</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;show-all-msgs&#39;</span><span class="p">,</span> <span class="nx">showAllMsgs</span><span class="p">)</span>  <span class="c1">// Added</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// Added</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;request-all-msgs&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// ... Omitted ...</span>
<span class="p">})();</span>
</pre></div>
<p>On server side, a <code>_msgs</code> global variable is added to keep all messages in
the history.  Besides, an event handler for <code>request-all-msgs</code> is
registered.  When the server receives a <code>request-all-msgs</code> event,
<code>handle_sync()</code> will send a <code>show-all-msgs</code> event along with the
<code>_msgs</code> list to the origin:</p>
<div class="highlight"><pre><span></span><span class="c1"># ... Omitted ...</span>

<span class="n">_msgs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Added</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>

<span class="nd">@socketio.on</span><span class="p">(</span><span class="s1">&#39;send-msg&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># Added</span>
    <span class="n">emit</span><span class="p">(</span><span class="s1">&#39;show-msg&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nd">@socketio.on</span><span class="p">(</span><span class="s1">&#39;request-all-msgs&#39;</span><span class="p">)</span>  <span class="c1"># Added</span>
<span class="k">def</span> <span class="nf">handle_sync</span><span class="p">():</span>
    <span class="n">emit</span><span class="p">(</span><span class="s1">&#39;show-all-msgs&#39;</span><span class="p">,</span> <span class="n">_msgs</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">socketio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
<p>Now, a newly joined user will see the dialogue before the user's entrance.</p>
</div>
<div class="section" id="using-database">
<h2>Using Database</h2>
<p>In the previous section, the message history was kept in a global variable.
However, all messages will be lost if the server is restarted.  To keep the
messages, the messages should be saved to a database.  In this section, I would
like to rewrite the server-side code to utilize SQLite database.</p>
<p>First, open <code>schema.sql</code> and write following SQL statements, which will
create a <code>livechat</code> table:</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">livechat</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">livechat</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="nb">text</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
</pre></div>
<p>Second, several modifications are required for <code>livechat.py</code>:</p>
<ul class="simple">
<li><code>flask.g</code> is imported to keep application variables for an
<em>appcontext</em>.</li>
<li><code>get_db()</code> will try to get the database handle from <code>flask.g</code>.
If it is not available, then it will open the database with
<code>_connect_db()</code>.  The returned database handle will be assigned to
<code>flask.g</code> as well.</li>
<li><code>close_db()</code> is decorated with <code>&#64;app.teardown_appcontext()</code> so
that the database connection can be closed before shutting down the
application.</li>
<li><code>init_db()</code> is a utility function to initialize the database.  It reuses
<code>get_db()</code> and <code>close_db()</code> by wrapping the code with
<code>with app.app_context()</code>.  It will open the database and execute
the SQL statements in <code>schema.sql</code>.</li>
<li><code>handle_message()</code> will save the message with an <code>INSERT INTO</code>
statement.</li>
<li><code>handle_sync()</code> will get all messages with a <code>SELECT</code> statement.</li>
</ul>
<p>Here is the code listing for <code>livechat.py</code>:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">g</span>  <span class="c1"># Modified</span>
<span class="kn">from</span> <span class="nn">flask_socketio</span> <span class="kn">import</span> <span class="n">SocketIO</span><span class="p">,</span> <span class="n">emit</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>  <span class="c1"># Added</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">socketio</span> <span class="o">=</span> <span class="n">SocketIO</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;livechat.sqlite&#39;</span>

<span class="k">def</span> <span class="nf">_connect_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_db</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_database&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">_connect_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@app.teardown_appcontext</span>
<span class="k">def</span> <span class="nf">close_db</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_database&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s1">&#39;schema.sql&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>

<span class="nd">@socketio.on</span><span class="p">(</span><span class="s1">&#39;send-msg&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>  <span class="c1"># Modified</span>
    <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO livechat(text) VALUES (?);&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">,))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">emit</span><span class="p">(</span><span class="s1">&#39;show-msg&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nd">@socketio.on</span><span class="p">(</span><span class="s1">&#39;request-all-msgs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_sync</span><span class="p">():</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># Modified</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT text FROM livechat ORDER BY id ASC;&#39;</span><span class="p">);</span>
    <span class="n">emit</span><span class="p">(</span><span class="s1">&#39;show-all-msgs&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">socketio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
<p>Now, initialize the SQLite database with:</p>
<div class="highlight"><pre><span></span>python -c <span class="s1">&#39;from livechat import init_db; init_db()&#39;</span>
</pre></div>
<p>With these changes, we can keep all messages in the database.  The messages will
no longer disappear after we restart the application.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>In this post, we learned how to write a small chat room application with
Flask-SocketIO.  In the example, we registered event handlers with the
<code>.on()</code> method and send events with the <code>.emit()</code> method.  We also
learned to keep appcontext variables in <code>flask.g</code> and decorate the
teardown callbacks with <code>&#64;app.teardown_appcontext</code>.  All of the code can
be found at my GitHub repositoy <a class="reference external" href="https://github.com/loganchien/livechat.">&#64;loganchien/livechat</a>.</p>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<p><em>Polling</em> (keep sending requests from clients) is an old trick to retrieve the
updates from the server, but polling will unnecessarily waste the network
bandwidth.  Several push technologies (sometimes referred as <a class="reference external" href="https://en.wikipedia.org/wiki/Comet_(programming)">Comet</a>) have been
developed.  For example, <em>long polling</em> is a variant of traditional polling.
Under long polling model, clients will send the request and <em>wait</em> for the
response from the server. The server will defer the response <em>until</em> the message
is available.  However, most techniques developed in early days have some
drawbacks and usually rely on the implementation details of browsers.
Fortunately, most use cases can be replaced by <a class="reference external" href="https://en.wikipedia.org/wiki/WebSocket">WebSocket</a> now.</p>
</div>

</div>

		</div>

		<div id="nav">
                        <div><a href="/"><img src="/theme/images/logo.png" id="logo" alt="" /></a></div>
                        <div><h1><a href="/">Logan's Note</a></h1></div>

<ul id="social-icon">
	<li><a href="http://facebook.com/loganchien" title="Facebook"><img src="/theme/images/facebook.png" alt="Facebook" /></a></li>
	<li><a href="http://plus.google.com/+LoganChienTW" title="Google+"><img src="/theme/images/gplus.png" alt="Google+" /></a></li>
	<li><a href="http://github.com/loganchien" title="GitHub"><img src="/theme/images/github.png" alt="GitHub" /></a></li>
	<li><a href="https://www.linkedin.com/in/loganchien" title="LinkedIn"><img src="/theme/images/linkedin.png" alt="LinkedIn" /></a></li>
	<li><a href="http://logan.tw/feeds/rss.xml" title="RSS Feed"><img src="/theme/images/feed.png" alt="RSS Feed" /></a></li>
	<li><a href="/email/" title="E-Mail" class="email-link"><img src="/theme/images/email.png" alt="E-Mail" /></a></li>
</ul>
			<ul id="menu">
				<li><a href="/">about</a></li>
				<li><a href="/blog/">blog</a></li>
				<li><a href="/tag/">tags</a></li>
				<li><a href="/archives/">archives</a></li>
			</ul>
		</div>

		<div id="footer">
<ul id="social">
	<li><a href="http://facebook.com/loganchien">Facebook</a></li>
	<li><a href="http://plus.google.com/+LoganChienTW">Google+</a></li>
	<li><a href="http://github.com/loganchien">GitHub</a></li>
	<li><a href="https://www.linkedin.com/in/loganchien">LinkedIn</a></li>
	<li><a href="http://logan.tw/feeds/rss.xml" title="RSS Feed">RSS</a></li>
	<li><a href="/email/" class="email-link">E-Mail</a></li>
</ul>
			<p id="copyright">&copy; Logan</p>
		</div>
	</div>

	<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-57011197-1']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = 'https://ssl.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
	</script>
</body>
</html>